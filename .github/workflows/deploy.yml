name: Deploy Docker Compose Stack to Production

env:
  SERVICE_DIRECTORY: ~/docker/chirpstack

on:
  push:
    branches:
      - main
    # Only run if the docker-compose.yml file changes
    paths:
      - 'compose.yml.template'
      - 'configuration/**'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-slim

    steps:
      # 1. Check out the repository code
      - name: Check out code
        uses: actions/checkout@v4

      # 2. Setup SSH Key
      - name: Set up SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}

      # 3. Add the host key to known_hosts to avoid interactive prompt
      - name: Add host key to known_hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_HOST_KEY }}" >> ~/.ssh/known_hosts

      # 4. Create directory structure
      - name: Create directory structure
        run: |
          # Create service directory
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST_IP }} "mkdir -p  ${{ env.SERVICE_DIRECTORY }}"

          # Create empty directories for persistent data and logs
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST_IP }} \
          "mkdir -p \
            ${{ env.SERVICE_DIRECTORY }}/data/postgresql \
            ${{ env.SERVICE_DIRECTORY }}/data/redis \
            ${{ env.SERVICE_DIRECTORY }}/logs/traefik"

      # 5. Populate the .env file with all necessary variables
      - name: Create *.env file
        run: |
          # Overwrite the file here
          echo "PRODUCTION_HOST_DOMAIN=${{ secrets.PRODUCTION_HOST_DOMAIN }}"   > .env

          # Append to the file from here on
          echo "POSTGRES_USER=${{ secrets.PRODUCTION_POSTGRES_USER }}"          >> .env
          echo "POSTGRES_PASSWORD=${{ secrets.PRODUCTION_POSTGRES_PW }}"        >> .env
          echo "POSTGRES_DB=${{ secrets.PRODUCTION_POSTGRES_DB }}"              >> .env

      # 6. Fill in variable placeholders in template files
      - name: Generate config files from templates
        env:
          TRAEFIK_ACME_EMAIL:       ${{ secrets.TRAEFIK_ACME_EMAIL }}
          HOST_DOMAIN:              ${{ secrets.PRODUCTION_HOST_DOMAIN }}
          POSTGRES_USER:            ${{ secrets.PRODUCTION_POSTGRES_USER }}
          POSTGRES_PW:              ${{ secrets.PRODUCTION_POSTGRES_PW }}
          CHIRPSTACK_API_SECRET:    ${{ secrets.PRODUCTION_CHIRPSTACK_API_SECRET }}
          CHIRPSTACK_UID:           ${{ secrets.PRODUCTION_CHIRPSTACK_UID }}
          CHIRPSTACK_GID:           ${{ secrets.PRODUCTION_CHIRPSTACK_GID }}
        run: |
          # Install envsubst tool, because it does not come with ubuntu-slim runner.
          sudo apt-get update && sudo apt-get install -y --no-install-recommends gettext-base

          VARS='
            $TRAEFIK_ACME_EMAIL 
            $HOST_DOMAIN 
            $POSTGRES_USER 
            $POSTGRES_PW 
            $CHIRPSTACK_API_SECRET
            $CHIRPSTACK_UID 
            $CHIRPSTACK_GID 
          '
          
          # Use envsubst to replace placeholders in the templates
          envsubst "$VARS" < compose.yml.template                                 > compose.yml
          envsubst "$VARS" < configuration/traefik/traefik.yml.template           > configuration/traefik/traefik.yml
          envsubst "$VARS" < configuration/chirpstack/chirpstack.toml.template    > configuration/chirpstack/chirpstack.toml

      # 7. Copy configuration files to Server
      - name: Copy config files to the server
        run: |
          scp -r configuration compose.yml .env ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST_IP }}:${{ env.SERVICE_DIRECTORY }}/

      # 8. Deploy on Server via SSH
      - name: Pull images and restart stack
        run: |
          # Connect using your new secret names
          ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST_IP }} << 'EOF'
            # Uncomment this line if your compose file is not in the home directory
            cd ${{ env.SERVICE_DIRECTORY }}
            
            # Pull the latest images specified in the compose file
            docker compose pull
            
            # Stop and recreate the containers in detached mode
            docker compose up -d --remove-orphans
          EOF
 